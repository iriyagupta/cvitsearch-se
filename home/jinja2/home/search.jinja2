{% extends 'base.jinja2' %}


{% block head %}

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="{{ static('js/transliterate.js') }}"></script>
  <link rel="stylesheet" href="{{ static('css/search.css') }}">
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>

  
{% endblock %}



{% block content %}

<main role="main" class="container main-container">

  <div class="container mt-3">
    <div class="row">
      <div class="col text-center">
        <!-- Search Bar -->
        <form action="{{ url('search') }}" method="GET">
          <div class="row">
            <div class="input-group input-group-sm col-6 first">
              <!-- Book input -->
                <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Search for book title or keyword" 
                maxlength="255" id="id_title" autofocus="" autocomplete="on">
            </div>

            <!-- Language Selection -->
            <div class="input-group col-2 second">
              <select id="language" name="language" class="form-control" onchange="javascript:languageChangeHandler()" 
              style="max-width: 80%; display: inline-block;">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="bn">Bengali</option>
                <option value="sa">Sanskrit</option>
                <option value="te">Telugu</option>
              </select>
            </div>

            <!-- Type of Search  -->
            <div class="input-group col-2 third">
              <select name="parameter" id="type" class="form-control">
                <option value="content" id="content">Content</option>
                <option value="title" id="title">Title</option>
                <option value="isbn" id="isbn">ISBN</option>
                <option value="author" id="author">Author</option>
              </select>
              <input type="hidden" > 
            </div>

           <!-- Submit Button -->
            <div class="input-group-append col-2 third">
                <button class="btn btn-outline-info" type="submit">Search</button>
            </div>
          </div>
        </form>
      </div>      
    </div>
  </div>
  <!-- Check if the results are generated for a particular query for finding the aggregate data -->
  {% if results %}
    <p class="text-center text-lowercase font-weight-light" style="font-size:0.8rem;"> {{ total }} are the results searched in {{ time_diff }} </p>
  {% else %}
    <p class="text-center text-lowercase font-weight-light" style="font-size:0.8rem;"> 0 results found in {{ time_diff }} secs. </p>
  {% endif %}

  <hr>

  <!-- Searched Results -->
  <div class="row">
    <div class="col-md-9">
      <div class="container mt-3">

        <!-- If results exists -->
        {% if results %}

          {% for res in results %}
            
            <div class="container">
              <div class="panel-group">
                <div class="panel panel-default">
                  <div class="panel-body">
                    <div class="row details">

                      <!-- Thumbnail -->
                      <div class="col-2">
                          <img class="image-res" id="img" src="{{ res.thumbnail.url }}"  alt="BookFrontImage" title="{{ res.title }}" style="height:90%; width:100%"/>
                      </div>


                      <!-- Check for content parameter for the change in UI -->
                      {% if request.GET.get('parameter')=="content" %}
                        <div class="col-10">
                          <!-- the title of the book -->
                          <p class="title"> {{ res.title }} - <i class="author"> {{ res.author }} </i></p>
                            <!-- Description of Books -->
                            <div class="row">
                              <div class="col-7">
                                <ul style="list-style-type: none;" class="description text-left">
                                  <li><strong>ISBN-13</strong> : {{ res.isbn }}</li>
                                  <li><strong>Language</strong> : {{ res.language }}</li>
                                  <li><strong>Genre</strong> : {{ res.genre }}</li>
                                  <li><strong>Source</strong> : {{ res.source }}</li>
                                  <li class="aboutdes post_body">
                                    {% if res.description %}
                                      <p class="abstract"><strong>Abstract</strong> : {{ res.description|safe|truncate(40) }}
                                    {% else %}
                                      <p class="abstract"><strong>Abstract</strong> : {{ "Unavailable Content. Read complete book for more information."|truncate(25) }}
                                    {% endif %}
                                      <a href="#{{ res }}" data-toggle="modal" data-target="#description{{ res.id }}">read more</a>
                                      </p>

                                      <!-- Modal for every book -->
                                      <div class="modal fade" id="description{{ res.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                          <div class="modal-content">
                                            <div class="modal-header w3-green">
                                              <h5 class="modal-title" id="myModalLabel"> {{ res.title }} - <i style="font-size:1rem;">{{ res.author }} </i></h5>
                                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                              </button>
                                            </div>
                                            <div class="modal-body">
                                              {% if res.book_pdf %}
                                                <p class="download" style="font-size:0.8rem;">
                                                  {% if res.description %}
                                                    {{ res.description }}
                                                  {% else %}
                                                    {{ "Unavailable Content. Read complete book for more information." }}
                                                  {% endif %}

                                                  <br> 

                                                  <p class="download" style="font-size:1rem;">
                                                    <strong >Read Complete Book here : </strong> <a href="{{ res.book_pdf.url }}" class="button small tooltip-test" title="Open Pdf"><i class="fa fa-download" aria-hidden="true"></i></a> 
                                                  </p>
                                                </p>
                                              {% else %}
                                              <p>
                                              <strong>We are sorry !!! No pdf Available. Come back later. </strong>
                                              </p>
                                              {% endif %}  
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                  </li>
                                </ul>
                              </div>
                              <!-- See Results About -->
                              <div class="col-5 aboutdes post_body">
                                <p style="font-size:0.8rem;">
                                  <strong>See results about</strong>

                                  <br>

                                    <a href="#{{ res }}" data-toggle="modal" data-target="#query{{ res.id }}">{{ q }} </a>

                                  <br>

                                  <span> {{ page_lines[page_list.filter(book__id=res.id)[0].id].0|safe|truncate(100) }} </span>
                                </p>
                              </div>
                              <!-- Modal for the See Results About section -->
                              <div class="modal fade" id="query{{ res.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="max-width: 40% !important;">
                                  <div class="modal-content">
                                    <div class="modal-header w3-green">
                                      <h5 class="modal-title" id="myModalLabel"> {{ res.title }} - <i style="font-size:1rem;">{{ res.author }} </i></h5>
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                      </button>
                                    </div>
                                    <div class="modal-body">    
                                      <!-- Card for every query obtained -->
                                      <div class="card-group">
                                        
                                          {% for page in page_list %}
                                            {% if page.book.id==res.id %}
                                              <div class="col-12">
                                                <div class="card">
                                                  <img class="card-img-top" src="{{ page.image.url }}" alt="Card Image" style="height:100%;">
                                                  <div class="card-body">
                                                    <h6 class="card-title">Retrieved Results</h6>
                                                    <small class="card-text"> {% for i in page_lines[page.id] %} {{ i }} <br><br>{% endfor %}</small>
                                                  </div>
                                                </div>
                                              </div>
                                            {% endif %}
                                          {% endfor %}
                                        
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                      {% else %}

                        <div class="col-10">
                          <!-- the title of the book -->
                          <p class="title"> {{ res.title }} - <i class="author"> {{ res.author }} </i></p>
                            <!-- Description of Books -->
                            <div class="row">

                              <div class="col-5">
                                <ul style="list-style-type: none;" class="description text-left">
                                  <li><strong>ISBN-13</strong> : {{ res.isbn }}</li>
                                  <li><strong>Language</strong> : {{ res.language }}</li>
                                  <li><strong>Genre</strong> : {{ res.genre }}</li>
                                  <li><strong>Source</strong> : {{ res.source }}</li>
                                  <li><strong>Download</strong> : <a href="{{ res.book_pdf.url }}" class="button small tooltip-test" title="Open Pdf"><i class="fa fa-download" aria-hidden="true"></i></a> </li>
                                </ul>
                              </div>

                              <div class="col-5">
                                <ul style="list-style-type: none;" class="description text-left">
                                  <li class="aboutdes post_body">
                                    {% if res.description %}
                                      <p class="abstract"><strong>Abstract</strong> : {{ res.description|safe|truncate(100) }}
                                      {% else %}
                                      <p class="abstract"><strong>Abstract</strong> : {{ "Unavailable description of the book. Read complete book for more information."|truncate(50) }}
                                    {% endif %}
                                      <a href="#{{ res }}" data-toggle="modal" data-target="#description{{ res.id }}">read more</a>
                                      </p>
                                      <!-- Modal for Book abstract -->
                                      <div class="modal fade" id="description{{ res.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                          <div class="modal-content">
                                            <div class="modal-header w3-green">
                                              <h5 class="modal-title" id="myModalLabel"> {{ res.title }} - <i style="font-size:1rem;">{{ res.author }} </i></h5>
                                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                              </button>
                                            </div>
                                            <div class="modal-body">
                                              {% if res.book_pdf %}
                                                <p class="download" style="font-size:0.8rem;">
                                                {% if res.description %}
                                                  {{ res.description }}
                                                {% else %}
                                                  {{ "Unavailable description of the book. Read complete book for more information." }}
                                                {% endif %}

                                                <br> 

                                                  <p class="download" style="font-size:1rem;">
                                                    <strong >Read Complete Book here : </strong> <a href="{{ res.book_pdf.url }}" class="button small tooltip-test" title="Open Pdf"><i class="fa fa-download" aria-hidden="true"></i></a> 
                                                  </p>
                                                </p>
                                              {% else %}
                                              <p><strong>No pdf available for now. We are working on getting you the complete resources.</strong></p>
                                              {% endif %}  
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                  </li>
                                </ul>
                              </div>

                      {% endif %}

                            </div>
                          </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}

          </div>
        </div>

        <!-- Filters for the Searched Results -->
        <div class="col-md-3">

          <div id="filter_div">
            <div class="row filter-heading-row">
              <div class="col">
                <h5 class="filter-heading">Filters</h5>
              </div>
              <div class="col my-auto" style="padding-right: 15px;">
                <a href="javascript:void(0)"
                   onclick='clearFilterParameters()'>
                  <button class="btn clear-btn float-right">
                   CLEAR ALL
                  </button>
                </a>
              </div>
            </div>

            <hr class="hr-sidebar">

            <div class="row filter-subheading-row">
              <div class="col">
                <h6 class="filter-subheading">Educational Category &mdash;</h6>
              </div>
              <div class="col" style="padding-right: 15px;">
                <a href="javascript:void(0)"
                   onclick='removeURLParameter("genre_param")'>
                  <button class="btn clear-btn float-right">
                    CLEAR
                  </button>
                </a>
              </div>
            </div>

            <ul class="filter-list" id="filter_genre_div">
              {% for genre,count in zipped %}
              <li class="filter-item" id="filter_by_genre_{{ genre }}">
                <a href="javascript:void(0)"
                   onclick='updateQueryStringParameter("genre_param", "{{ genre }}" )'>
                  <div class="row align-items-center" style="padding-right: 10px;">
                    <div class="col-9">
                      {{ genre }}
                    </div>
                  <div class="col-3 text-right" style="padding-right: 20px;">
                      <div class="count-box">
                      {{ count }}
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              {% endfor %}
            </ul>


            <hr class="hr-sidebar">

            <div class="row filter-subheading-row">
              <div class="col">
                <h6 class="filter-subheading">Source &mdash;</h6>
              </div>
              <div class="col" style="padding-right: 15px;">
                <a href="javascript:void(0)"
                   onclick='removeURLParameter("source_param")'>
                  <button class="btn clear-btn float-right">
                    CLEAR
                  </button>
                </a>
              </div>
            </div>


            <ul class="filter-list" id="filter_source_div">
              {% for source,count in zipped_list %}
              <li class="filter-item" id="filter_by_source_{{ source }}">
                <a href="javascript:void(0)"
                   onclick='updateQueryStringParameter("source_param", "{{ source }}" )'>
                  <div class="row align-items-center" style="padding-right: 10px;">
                    <div class="col-9">
                      {{ source }}
                    </div>
                    <div class="col-3 text-right" style="padding-right: 20px;">
                      <div class="count-box">
                      {{ count }}
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              {% endfor %}
            </ul>




          </div>

        </div>

        {% endif %}
      </div>
    </div>
  </div>
</main>

{% endblock %}



{% block foot %}


<script>
$(document).ready(function() {
  // filter by genre
  genre_param = get('genre_param');
  if (genre_param !== undefined) {
    filter_genre_id = '#filter_by_genre_' + genre_param;
    $('#filter_genre_div li').removeClass('filter-active');
    $(filter_genre_id).addClass('filter-active');
  };

  // filter by source
  source_param = get('source_param');
  if (source_param !== undefined) {
    filter_source_id = '#filter_by_source_' + source_param;
    $('#filter_source_div li').removeClass('filter-active');
    $(filter_source_id).addClass('filter-active');
  };
  
});



function get(name) {
   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
};
// Credits: https://stackoverflow.com/a/6021027/3187043
function updateQueryStringParameter(key, value) {
  var url = window.location.href
  // remove page number
  // prefer to use l.search if you have a location/link object
  var urlparts= url.split('?');
  var new_url;
  if (urlparts.length>=2) {
      var pg_prefix= encodeURIComponent('page')+'=';
      var pars= urlparts[1].split(/[&;]/g);
      //reverse iteration as may be destructive
      for (var i= pars.length; i-- > 0;) {
          //idiom for string.startsWith
          if (pars[i].lastIndexOf(pg_prefix, 0) !== -1 ) {
              pars.splice(i, 1);
          }
      }
      new_url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : '');
      console.log(new_url);
  }
  else {
      new_url = url;
  }
  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
  var separator = new_url.indexOf('?') !== -1 ? "&" : "?";
  if (new_url.match(re)) {
    window.location = new_url.replace(re, '$1' + key + "=" + value + '$2');
  }
  else {
    window.location = new_url + separator + key + "=" + value;
  }
};
// Credits: https://stackoverflow.com/a/1634841/3187043
function removeURLParameter(parameter) {
    var url = window.location.href
    var is_param_present = false;
    // prefer to use l.search if you have a location/link object
    var urlparts= url.split('?');
    if (urlparts.length>=2) {
        var prefix= encodeURIComponent(parameter)+'=';
        var pg_prefix= encodeURIComponent('page')+'=';
        var pars= urlparts[1].split(/[&;]/g);
        //reverse iteration as may be destructive
        for (var i= pars.length; i-- > 0;) {
            //idiom for string.startsWith
            if (pars[i].lastIndexOf(prefix, 0) !== -1 ) {
                is_param_present = true;
                pars.splice(i, 1);
            }
        }
        if (is_param_present === true) {
          for (var i= pars.length; i-- > 0;) {
              //idiom for string.startsWith
              if (pars[i].lastIndexOf(pg_prefix, 0) !== -1 ) {
                  pars.splice(i, 1);
              }
          }
        }
        window.location = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : '');
        return;
    }
    return;
};
function clearFilterParameters() {
    var url = window.location.href
    var is_any_filter_param_present = false;
    // prefer to use l.search if you have a location/link object
    var urlparts= url.split('?');
    if (urlparts.length>=2) {
        var genre_prefix= encodeURIComponent('genre_param')+'=';
        var source_prefix= encodeURIComponent('source_param')+'=';
        var pars= urlparts[1].split(/[&;]/g);
        //reverse iteration as may be destructive
        for (var i= pars.length; i-- > 0;) {
            //idiom for string.startsWith
            if (pars[i].lastIndexOf(genre_prefix, 0) !== -1 ||
                pars[i].lastIndexOf(source_prefix, 0) !== -1 ) {
                is_any_filter_param_present = true;
                pars.splice(i, 1);
            }
        }
        if (is_any_filter_param_present) {
          for (var i= pars.length; i-- > 0;) {
              //idiom for string.startsWith
              if (pars[i].lastIndexOf(pg_prefix, 0) !== -1) {
                  pars.splice(i, 1);
              }
          }
        }
        window.location = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : '');
        return;
    }
    return;
};


</script>
{% endblock %}